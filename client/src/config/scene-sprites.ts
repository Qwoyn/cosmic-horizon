import type { SpriteDefinition } from './pixel-sprites';

// Color constants matching pixel-sprites.ts
const MAGENTA = '#e847a0';
const GREEN   = '#3fb950';
const BLUE    = '#58a6ff';
const YELLOW  = '#d29922';
const ORANGE  = '#f0883e';
const RED     = '#f85149';
const WHITE   = '#c9d1d9';
const GREY    = '#8b949e';
const DARK    = '#161b22';

/**
 * Generate 3 exhaust frame variants from any ship sprite.
 * Modifies the bottom 3 rows to add flickering orange/yellow thruster pixels.
 */
export function makeExhaustFrames(base: SpriteDefinition): SpriteDefinition[] {
  // Find exhaust color index (orange) in palette, or add it
  const exhaustPatterns = [
    // Frame 0: small exhaust
    [0.3, 0.0, 0.6],
    // Frame 1: medium exhaust
    [0.7, 0.4, 0.9],
    // Frame 2: large exhaust
    [1.0, 0.8, 0.5],
  ];

  return exhaustPatterns.map((intensities) => {
    const palette = [...base.palette, ORANGE, YELLOW, RED];
    const orangeIdx = palette.length - 3;
    const yellowIdx = palette.length - 2;
    const redIdx = palette.length - 1;
    const grid = base.grid.map(row => [...row]);
    const lastRow = grid.length - 1;

    // Find center columns (where the ship body exists in bottom rows)
    const centerCols: number[] = [];
    for (let r = Math.max(0, lastRow - 4); r <= lastRow; r++) {
      for (let c = 0; c < grid[r].length; c++) {
        if (grid[r][c] !== 0 && !centerCols.includes(c)) {
          centerCols.push(c);
        }
      }
    }
    centerCols.sort((a, b) => a - b);

    // Add exhaust below existing pixels in bottom 3 rows
    for (let ri = 0; ri < 3 && lastRow - ri >= 0; ri++) {
      const row = lastRow - ri;
      for (let c = 0; c < grid[row].length; c++) {
        if (grid[row][c] === 0 && centerCols.includes(c)) {
          const intensity = intensities[ri] || 0;
          if (Math.random() < intensity) {
            const colorChoice = Math.random();
            if (colorChoice < 0.4) grid[row][c] = orangeIdx;
            else if (colorChoice < 0.7) grid[row][c] = yellowIdx;
            else grid[row][c] = redIdx;
          }
        }
      }
    }

    return { cols: base.cols, rows: base.rows, palette, grid };
  });
}

// === Station sprite (16x16, 2 frames with blinking lights) ===
export const SCENE_SPRITES = {
  station_frame1: {
    cols: 16, rows: 16,
    palette: ['', GREY, WHITE, BLUE, GREEN, DARK, MAGENTA],
    grid: [
      [0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,2,3,3,2,0,0,0,0,0,0],
      [0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],
      [0,0,0,0,2,1,1,5,5,1,1,2,0,0,0,0],
      [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
      [0,0,4,1,1,1,5,5,5,5,1,1,1,4,0,0],
      [0,2,1,1,1,5,5,5,5,5,5,1,1,1,2,0],
      [2,1,1,1,5,5,6,5,5,6,5,5,1,1,1,2],
      [2,1,1,1,5,5,5,5,5,5,5,5,1,1,1,2],
      [0,2,1,1,1,5,5,5,5,5,5,1,1,1,2,0],
      [0,0,4,1,1,1,5,5,5,5,1,1,1,4,0,0],
      [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
      [0,0,0,0,2,1,1,5,5,1,1,2,0,0,0,0],
      [0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],
      [0,0,0,0,0,0,2,1,1,2,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0],
    ],
  } as SpriteDefinition,

  station_frame2: {
    cols: 16, rows: 16,
    palette: ['', GREY, WHITE, BLUE, RED, DARK, MAGENTA],
    grid: [
      [0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,2,3,3,2,0,0,0,0,0,0],
      [0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],
      [0,0,0,0,2,1,1,5,5,1,1,2,0,0,0,0],
      [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
      [0,0,4,1,1,1,5,5,5,5,1,1,1,4,0,0],
      [0,2,1,1,1,5,5,5,5,5,5,1,1,1,2,0],
      [2,1,1,1,5,5,6,5,5,6,5,5,1,1,1,2],
      [2,1,1,1,5,5,5,5,5,5,5,5,1,1,1,2],
      [0,2,1,1,1,5,5,5,5,5,5,1,1,1,2,0],
      [0,0,4,1,1,1,5,5,5,5,1,1,1,4,0,0],
      [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
      [0,0,0,0,2,1,1,5,5,1,1,2,0,0,0,0],
      [0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],
      [0,0,0,0,0,0,2,1,1,2,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0],
    ],
  } as SpriteDefinition,

  // Outpost/dock sprite (16x16, 2 frames with green docking lights)
  outpost_frame1: {
    cols: 16, rows: 16,
    palette: ['', GREY, WHITE, GREEN, DARK, BLUE],
    grid: [
      [0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0],
      [0,0,0,0,0,2,1,1,1,1,2,0,0,0,0,0],
      [0,0,0,0,2,1,4,4,4,4,1,2,0,0,0,0],
      [0,0,0,2,1,4,5,4,4,5,4,1,2,0,0,0],
      [0,0,2,1,4,4,4,4,4,4,4,4,1,2,0,0],
      [0,3,1,1,4,4,4,4,4,4,4,4,1,1,3,0],
      [0,0,2,1,4,4,4,4,4,4,4,4,1,2,0,0],
      [0,0,0,2,1,4,4,4,4,4,4,1,2,0,0,0],
      [0,0,0,0,2,1,1,1,1,1,1,2,0,0,0,0],
      [0,0,0,0,0,2,1,1,1,1,2,0,0,0,0,0],
      [0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    ],
  } as SpriteDefinition,

  outpost_frame2: {
    cols: 16, rows: 16,
    palette: ['', GREY, WHITE, YELLOW, DARK, BLUE],
    grid: [
      [0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0],
      [0,0,0,0,0,2,1,1,1,1,2,0,0,0,0,0],
      [0,0,0,0,2,1,4,4,4,4,1,2,0,0,0,0],
      [0,0,0,2,1,4,5,4,4,5,4,1,2,0,0,0],
      [0,0,2,1,4,4,4,4,4,4,4,4,1,2,0,0],
      [0,3,1,1,4,4,4,4,4,4,4,4,1,1,3,0],
      [0,0,2,1,4,4,4,4,4,4,4,4,1,2,0,0],
      [0,0,0,2,1,4,4,4,4,4,4,1,2,0,0,0],
      [0,0,0,0,2,1,1,1,1,1,1,2,0,0,0,0],
      [0,0,0,0,0,2,1,1,1,1,2,0,0,0,0,0],
      [0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    ],
  } as SpriteDefinition,

  // Explosion (12x12, 4 frames)
  explosion_frame1: {
    cols: 12, rows: 12,
    palette: ['', WHITE, YELLOW, ORANGE],
    grid: [
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,1,1,0,0,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [0,0,0,0,1,1,1,1,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
    ],
  } as SpriteDefinition,

  explosion_frame2: {
    cols: 12, rows: 12,
    palette: ['', WHITE, YELLOW, ORANGE, RED],
    grid: [
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,2,0,0,2,0,0,0,0],
      [0,0,0,2,1,2,2,1,2,0,0,0],
      [0,0,2,1,1,1,1,1,1,2,0,0],
      [0,2,1,1,2,1,1,2,1,1,2,0],
      [0,0,2,1,1,1,1,1,1,2,0,0],
      [0,0,2,1,1,1,1,1,1,2,0,0],
      [0,2,1,1,2,1,1,2,1,1,2,0],
      [0,0,2,1,1,1,1,1,1,2,0,0],
      [0,0,0,2,1,2,2,1,2,0,0,0],
      [0,0,0,0,2,0,0,2,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
    ],
  } as SpriteDefinition,

  explosion_frame3: {
    cols: 12, rows: 12,
    palette: ['', YELLOW, ORANGE, RED, GREY],
    grid: [
      [0,0,0,3,0,0,0,0,3,0,0,0],
      [0,0,3,0,2,0,0,2,0,3,0,0],
      [0,3,0,2,1,2,2,1,2,0,3,0],
      [3,0,2,1,2,1,1,2,1,2,0,3],
      [0,2,1,2,0,2,2,0,2,1,2,0],
      [0,0,2,1,2,0,0,2,1,2,0,0],
      [0,0,2,1,2,0,0,2,1,2,0,0],
      [0,2,1,2,0,2,2,0,2,1,2,0],
      [3,0,2,1,2,1,1,2,1,2,0,3],
      [0,3,0,2,1,2,2,1,2,0,3,0],
      [0,0,3,0,2,0,0,2,0,3,0,0],
      [0,0,0,3,0,0,0,0,3,0,0,0],
    ],
  } as SpriteDefinition,

  explosion_frame4: {
    cols: 12, rows: 12,
    palette: ['', GREY, DARK],
    grid: [
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,1,0,0,1,0,0,0,0],
      [0,0,0,1,0,0,0,0,1,0,0,0],
      [0,0,1,0,0,2,2,0,0,1,0,0],
      [0,1,0,0,2,0,0,2,0,0,1,0],
      [0,0,0,2,0,0,0,0,2,0,0,0],
      [0,0,0,2,0,0,0,0,2,0,0,0],
      [0,1,0,0,2,0,0,2,0,0,1,0],
      [0,0,1,0,0,2,2,0,0,1,0,0],
      [0,0,0,1,0,0,0,0,1,0,0,0],
      [0,0,0,0,1,0,0,1,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
    ],
  } as SpriteDefinition,

  // Hit flash (16x16, 1 frame) - bright overlay of generic ship shape
  hit_flash: {
    cols: 16, rows: 16,
    palette: ['', WHITE, YELLOW],
    grid: [
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    ],
  } as SpriteDefinition,

  // Planet for arrival scene (12x12)
  planet_arrival: {
    cols: 12, rows: 12,
    palette: ['', BLUE, GREEN, '#2a6aaa', GREY],
    grid: [
      [0,0,0,0,4,4,4,4,0,0,0,0],
      [0,0,0,4,1,1,1,1,4,0,0,0],
      [0,0,4,1,1,2,1,1,1,4,0,0],
      [0,4,1,1,2,2,1,1,1,1,4,0],
      [4,1,1,1,2,3,1,1,1,1,1,4],
      [4,1,2,1,3,3,1,1,2,1,1,4],
      [4,1,1,1,1,1,1,2,2,1,1,4],
      [4,1,1,1,1,1,1,2,1,1,1,4],
      [0,4,1,1,2,1,1,1,1,1,4,0],
      [0,0,4,1,1,1,1,1,1,4,0,0],
      [0,0,0,4,1,1,1,1,4,0,0,0],
      [0,0,0,0,4,4,4,4,0,0,0,0],
    ],
  } as SpriteDefinition,
};
